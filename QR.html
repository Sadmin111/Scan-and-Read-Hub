<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Test Download</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body style="font-family: system-ui, sans-serif; display:flex; align-items:center; justify-content:center; min-height:100vh; background:#020617; color:white;">

  <div>
    <h2>Test QR Download</h2>
    <button type="button" onclick="generateQR()">Generate QR</button>
    <button type="button" onclick="downloadQR()">Download QR</button>
    <div id="qrcode" style="margin-top:16px;"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    let qr;

    function generateQR() {
      const container = document.getElementById("qrcode");
      container.innerHTML = "";
      qr = new QRCode(container, {
        text: "Hello from test page",
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.H
      });
      alert("QR generated. Now click Download.");
    }

    function downloadQR() {
      try {
        const container = document.getElementById("qrcode");
        const canvas = container.querySelector("canvas");
        const img = container.querySelector("img");

        if (!canvas && !img) {
          alert("No QR yet. Click Generate first.");
          return;
        }

        function trigger(url) {
          alert("Triggering downloadâ€¦");
          const a = document.createElement("a");
          a.href = url;
          a.download = "qrcode.png";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }

        // If rendered as canvas
        if (canvas) {
          if (canvas.toBlob) {
            canvas.toBlob(function(blob) {
              if (!blob) {
                alert("Could not export QR image.");
                return;
              }
              const url = URL.createObjectURL(blob);
              trigger(url);
              setTimeout(() => URL.revokeObjectURL(url), 1000);
            }, "image/png");
          } else {
            const dataURL = canvas.toDataURL("image/png");
            trigger(dataURL);
          }
          return;
        }

        // If rendered as img
        if (img && img.src) {
          const tempCanvas = document.createElement("canvas");
          const size = 200;
          tempCanvas.width = size;
          tempCanvas.height = size;
          const ctx = tempCanvas.getContext("2d");

          const tempImg = new Image();
          tempImg.crossOrigin = "anonymous";
          tempImg.onload = function () {
            ctx.drawImage(tempImg, 0, 0, size, size);
            if (tempCanvas.toBlob) {
              tempCanvas.toBlob(function (blob) {
                if (!blob) {
                  alert("Could not export QR image.");
                  return;
                }
                const url = URL.createObjectURL(blob);
                trigger(url);
                setTimeout(() => URL.revokeObjectURL(url), 1000);
              }, "image/png");
            } else {
              const dataURL = tempCanvas.toDataURL("image/png");
              trigger(dataURL);
            }
          };
          tempImg.src = img.src;
        }
      } catch (e) {
        alert("Error in downloadQR: " + e.message);
      }
    }
  </script>
</body>
</html>
